<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Music Wars</title>
        <style type="text/css">
            html, body, canvas {
                margin: 0px;
                padding: 0px;
                overflow: hidden;
                background: #090B1C;
            }
            * {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            .no-cursor {
                cursor: none !important;
            }
        </style>
        <script type="text/javascript" src="./js/ivank-0.72.js"></script>
        <script type="text/javascript" src="./js/t.js"></script>
        <script type="text/javascript" src="./js/jquery-2.0.0.min.js"></script>
        <script type="text/javascript" src="./js/fullscreen.js"></script>
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
          ga('create', 'UA-34543516-2', 'brittg.com');
          ga('send', 'pageview');
        </script>

        <script type="text/javascript">

            version = "0.85a";
            author = "Britt Gresham";

            var photosensitiveWarningTitle = "PHOTOSENSITIVE WARNING: READ BEFORE PLAYING!";
            var photosensitiveWarning = "A very small percentage of individuals may experience epileptic seizures" + 
            " when exposed to certain light patterns or flashing lights.\nExposure to certain patterns or backgrounds" +
            " on a computer screen, or while playing video games, may induce an epileptic seizure in these individuals.\n" +
            "Certain conditions may induce previously undetected epileptic symptoms even in persons who have no history " +
            "of prior seizures or epilepsy.\n\nIf you, or anyone in your family, have an epileptic condition, consult your physician" + 
            " prior to playing. If you experience any of the following symptoms while playing a video or computer game -- " + 
            "dizziness, altered vision, eye or muscle twitches, loss of awareness, disorientation, any involuntary movement, or " + 
            "convulsions -- IMMEDIATELY discontinue use and consult your physician before resuming play."

            $(document).ready(function() {
                var filePrompt = document.getElementById('fileUploadForm');
                filePrompt.addEventListener('change', getSongFromComputer, false);
            });
            var audioContext = new webkitAudioContext();
            var songPlaying = false;

            var game_buffer = {};
            function getSongFromComputer(eventObj) {
                showLoadingScreen();
                var filename = eventObj.target.files[0];
                var reader = new FileReader();
                reader.onload = function() {
                    audioContext.decodeAudioData(reader.result, function(buffer) {
                            game_buffer = {
                                'buffer': buffer,
                                'starttime': 0,
                                'pausetime': 0,
                                'offset': 0,
                            };
                        playBuffer(game_buffer, 1, 0);
                        showGameScreen();
                    });
                };
                reader.readAsArrayBuffer(filename);
            }

            var mainMenuSource;
            var paused = false;

            function pause() {
                if (!songPlaying) return;
                source.stop(0);
                game_buffer['pausetime'] = audioContext.currentTime;
                game_buffer['offset'] += game_buffer['pausetime'] - game_buffer['starttime'];
                paused = true;
            }

            function play() {
                if (!songPlaying) return;
                playBuffer(game_buffer, 0, game_buffer['offset']);
                paused = false;
            }

            function playBuffer(audioBuffer, playDelay, offset) {
                Tweener.addTween(mainMenuSource.gain, {value:0, time:3});

                source = audioContext.createBufferSource();
                analyser = audioContext.createAnalyser();
                highpass = audioContext.createBiquadFilter();
                delay = audioContext.createDelay();

                source.buffer = audioBuffer['buffer'];
                
                source.connect(analyser);
                analyser.connect(highpass);
                highpass.connect(delay);
                delay.connect(audioContext.destination);

                resetSoundEffects()

                source.start(playDelay, offset);
                songPlaying = true;
                audioBuffer['starttime'] = audioContext.currentTime;
            }

            function resetSoundEffects() {
                bpm = 0;
                bpmObj = {};
                lastBeat = now();
                source.playbackRate.value = 1;
                delay.delayTime.value = .06;
                analyser.smoothingTimeConstant = 0;
                highpass.type = highpass.ALLPASS;
                highpass.Q.value = 0;
                
            }

            var bulletShot;
            var mainMenuBuffer;
            function preLoadBuffers() {
                // Main Menu Music
                var menuMusicRequest = new XMLHttpRequest();
                menuMusicRequest.open("GET", "./sounds/menu.ogg", true);
                menuMusicRequest.responseType = "arraybuffer";
                menuMusicRequest.onload = function() {
                    audioContext.decodeAudioData(menuMusicRequest.response, function(buffer) {
                        mainMenuBuffer = buffer;
                        Tweener.addTween(epilepsyWarningSplash.acceptBtn, {alpha: 1, time: 2, transition: "easeInOutExpo"});
                    });
                }
                menuMusicRequest.send();

                // Gun fire sound effect
                var bulletFireRequest = new XMLHttpRequest();
                bulletFireRequest.open('GET', "./sounds/gunfire.wav", true);
                bulletFireRequest.responseType = 'arraybuffer';
                bulletFireRequest.onload = function() {
                    audioContext.decodeAudioData(bulletFireRequest.response, function(buffer) {
                        bulletShot = buffer;
                    });
                }
                bulletFireRequest.send();
            }

            function playBulletShot() {
                var source = audioContext.createBufferSource();
                source.playbackRate.value = .7 + (Math.random() * .2);
                source.buffer = bulletShot;
                source.gain.value = .1 + (Math.random() * .05);
                source.connect(audioContext.destination);
                source.start(0);
            }

        </script>

        <script type="text/javascript">

            function Button(name)	// extends Sprite
            {
                Sprite.apply(this);
                this.buttonMode = true;
                this.mouseChildren = false;
                this.name = name;
                
                this.t = new TextField();
                this.t.setTextFormat(Button.tFormat);
                this.t.text = name;
                this.t.x = 5;
                this.t.y = 6;
                this.t.width = (this.t.textWidth > 136) ? this.t.textWidth : 136;
                this.t.height = this.t.textHeight;
                this.addChild(this.t);
                
                this.btnBorder = new BitmapData("./img/btn.png", 1);
                this.btnTop = new Bitmap(this.btnBorder);
                this.btnBottom = new Bitmap(this.btnBorder);
                this.btnBottom.y = this.t.GetHeight() + 10;
                this.addChild(this.btnTop);
                this.addChild(this.btnBottom);

                this.graphics.beginFill(0x000000, 0.01);
                this.graphics.drawRect(0, 0, this.t.GetWidth() + 10, this.t.GetHeight() + 10);
                
                this.bg = new Sprite();		// bg is a layer with dark blue rectangle
                this.bg.graphics.beginFill(0x0066dd, 0.01);
                this.bg.graphics.drawRect(0, 0, this.t.GetWidth() + 10, this.t.GetHeight() + 10);
                this.addChild(this.bg);
                
                this.addEventListener(MouseEvent.MOUSE_OVER, this.onMOv);
                this.addEventListener(MouseEvent.MOUSE_OUT , this.onMOu);
            }
            Button.prototype = new Sprite();

            //	static variable
            Button.tFormat    = new TextFormat("Arial", 25, 0xffffff, false, false, "center");

            //	methods
            Button.prototype.onMOv = function(e) { e.target.bg.visible = false; }
            Button.prototype.onMOu = function(e) { e.target.bg.visible = true; }

            function Explosion() {
                Sprite.apply(this);
                this.addEventListener(Event.ENTER_FRAME, this.draw);
                this.startTime = now();
                this.expires = 3;
                this.radius = 1;
                this.growthRate = 1.1;
                this.opacity = 1;

                this.remove = removeSprite;

                this.graphics.beginFill(0xe49d5e, 1);
                this.graphics.drawCircle(0,0,this.radius);
            }
            Explosion.prototype = new Sprite();
            Explosion.prototype.draw = function(e) {
                if (paused) return;
                e.target.graphics.clear();
                var red = 155 + e.target.radius * 1;
                var green = 0 + e.target.radius * 2;
                var blue = 0;
                red = (red > 255) ? 255 : red;
                green = (green > 255) ? 255 : green;
                var color = ((1 << 24) + (red << 16) + (green << 8) + blue);
                e.target.graphics.beginFill(color, e.target.opacity);
                e.target.growthRate += 0.9;
                e.target.radius += e.target.growthRate;
                if (e.target.radius >= 50) {
                    e.target.opacity -= .1;
                    if (e.target.opacity <= 0) {
                        e.target.remove();
                    }
                }
                e.target.graphics.drawCircle(0,0,e.target.radius);
            }

            function Player() {
                Sprite.apply(this);
                this.addEventListener(Event.ENTER_FRAME, this.draw);
                this.alive = true;
                this.health = 100;
                this.lives = 3;
                this.score = 0;
                this.displayScore = 0;
                this.powerups = [];
                this.lastBulletFired = 0;
                this.collides = true;

                this.hit = function(dmg) {
                    if (this.alive)
                        this.health -= dmg;
                    if (this.health <= 0) {
                        this.lives -= 1;
                        this.explode();
                        this.health = 100;
                        if (this.lives <= 0) {
                            this.explode();
                            this.alive = false;
                            highpass.type = highpass.BANDPASS;
                            highpass.Q.value = 1.5;
                        } else {
                            var inv = new Invuln();
                            inv.soundEffectEnabled = true;
                            this.powerups.push(inv);
                        }
                    }
                };

                this.explode = explode;

                this.reset = function() {
                    this.alive = true;
                    this.health = 100;
                    this.lives = 3;
                    for (var x in this.powerups) {
                        this.powerups[x].deactivate(this);
                        this.powerups.splice(x,1);
                    }
                }

                this.addBullet = function() {
                    if (Math.abs(this.lastBulletFired - now()) > 60000 / bpm) {
                        playBulletShot();
                        this.lastBulletFired = now();
                        gamePlayScene.addChild(new Bullet(this.x, this.y, intensity));
                    }
                }

                this.enemyCheck = function() {
                    for (var x in gamePlayScene._children) {
                        if (gamePlayScene._children[x].collides == true) {
                            if (this.hitTestObject(gamePlayScene._children[x]) && gamePlayScene._children[x] != gamePlayScene.player) {
                                this.hit(gamePlayScene._children[x].damage);
                                gamePlayScene._children[x].explode();
                                gamePlayScene._children[x].remove();
                            }
                        }
                    }
                }

                this.updatePowerups = function() {
                    for (var x in this.powerups) {
                        if (this.powerups[x].active) {
                            if (this.powerups[x].expires < now()) {
                                this.powerups[x].deactivate(this);
                                this.powerups.splice(x,1);
                            } else {
                                this.powerups[x].running(this);
                            }
                        } else {
                            this.powerups[x].activate(this);
                        }
                    }
                }

                this.graphics.beginFill(0xffffff, 1);
                this.graphics.drawRect(0,0,10,36);
                this.graphics.drawRect(10,10,10,16);
                this.graphics.drawRect(20,14,5,1);
                this.graphics.drawRect(20,21,5,1);
            }
            Player.prototype = new Sprite();
            Player.prototype.draw = function(e) {
                if (paused) return;
                if (e.target.alive) {
                    var movementBonus = 1;
                    if (intensity / 4 > 0) {
                        movementBonus += intensity / 4;
                    }
                    movementBonus = movementBonus / 6 * 12;
                    if (u) e.target.y -= 8 + movementBonus;
                    if (d) e.target.y += 8 + movementBonus;
                    if (l) e.target.x -= 8 + movementBonus;
                    if (r) e.target.x += 8 + movementBonus;

                    if (e.target.x > width - 20) e.target.x = width - 20;
                    if (e.target.x < 0) e.target.x = 0;
                    if (e.target.y > height - 36) e.target.y = height - 36;
                    if (e.target.y < 0) e.target.y = 0;
                    if (fire) e.target.addBullet();
                }
                e.target.enemyCheck();
                e.target.updatePowerups();
            }

            function ExtraHealth(health) {
                if (health == null) {
                    this.health = 50;
                } else {
                    this.health = health;
                }
                this.name = "Extra Health";
                this.active = false;
                this.activate = function(e) {
                    this.start = now();
                    this.active = true;
                    this.expires = this.start;
                    e.health += this.health;
                }
                this.running = function() {};
                this.deactivate = function() {};
            }
            function ExtraLife() {
                this.name = "Extra Life";
                this.active = false;
                this.activate = function(e) {
                    this.start = now();
                    this.active = true;
                    this.expires = this.start;
                    e.lives += 1;
                }
                this.running = function() {};
                this.deactivate = function() {};
            }
            function Invuln() {
                this.name = "Invulnerability";
                this.active = false;
                this.soundEffectEnabled = false;
                this.shield = new Sprite();
                this.shield.graphics.beginFill(0xffffff, .5);
                this.activate = function(e) {
                    this.start = now();
                    this.expires = this.start + this.duration;
                    this.active = true;
                    if (this.soundEffectEnabled) {
                        highpass.Q.value = 0;
                        highpass.frequency.value = 2000;
                        highpass.type = highpass.BANDPASS;
                        Tweener.addTween(highpass.Q, {value: 2, time: this.duration / 4000, transition: "easeInOutExpo"});
                        Tweener.addTween(highpass.Q, {value: 0, time: this.duration / 4000, delay: 3 * this.duration / 4000, transition: "easeInOutExpo"});

                        // Tweener.addTween(highpass.frequency, {value: 2000, time: this.duration / 2000, transition: "easeInOutExpo"});
                        // Tweener.addTween(highpass.frequency, {value: 10, time: this.duration / 2000, delay: this.duration / 2000, transition: "easeInOutExpo"});
                    }
                    e._hit = e.hit;
                    e.hit = function(dmg) {
                    }
                    e.alpha = .35;
                    this.shield.graphics.drawCircle(e.GetWidth() / 2, e.GetHeight() / 2, Math.max(e.GetWidth(), e.GetHeight()) + 2);
                    e.addChild(this.shield);
                }
                this.running = function(e) {
                    if (this.expires - now() < (this.duration / 4)) {
                        if (~~(this.expires - now() / 100) % 2) {
                            this.shield.alpha = .25;
                        } else {
                            this.shield.alpha = 1;
                        }
                    }
                }
                this.deactivate = function(e) {
                    this.active = false;
                    if (this.soundEffectEnabled) {
                        highpass.Q.value = 0;
                        highpass.type = highpass.ALLPASS;
                    }
                    e.hit = e._hit;
                    e._hit = function(dmg) {
                    }
                    e.alpha = 1;
                    e.removeChild(this.shield);
                }
                this.duration = 5000;
            }


            var enemyCount = 0;
            function Enemy() {
                Sprite.apply(this);
                enemyCount += 1;
                this.addEventListener(Event.ENTER_FRAME, this.draw);
                this.health = 50;
                this.damage = 40;
                this.collides = true;

                this.hit = function(dmg) {
                    this.health -= dmg;
                    if (this.health <= 0) {
                        this.explode();
                        enemyCount -= 1;
                        this.parent.player.score += 100;
                        Tweener.addTween(gamePlayScene.player, {displayScore:gamePlayScene.player.score, time:2});
                        this.remove();
                    }
                }

                this.remove = removeSprite;
                this.explode = explode;

                this.graphics.beginFill(0xcc6600);
                this.graphics.drawRect(0,0,25,25);
            }
            Enemy.prototype = new Sprite();
            Enemy.prototype.draw = function(e) {
                if (paused) return;
                if (e.target.x < 0) {
                    enemyCount -= 1;
                    e.target.remove();
                }
                var boost = (intensity > 0) ? (intensity / 3) : 0;
                e.target.x -= 10 + boost;
                e.target.y += enemyCount / 50;
                if (e.target.y > height)
                    e.target.y = 0;
                if (e.target.y < 0)
                    e.target.y = height;
            }

            function Bullet(x, y) {
                Sprite.apply(this);
                this.x = x;
                this.y = y + Math.random() * 1;
                this.collides = false;
                this.addEventListener(Event.ENTER_FRAME, this.draw);
                this.damage = (intensity > 0) ? 20 + intensity : 20;
                this.speed = (intensity > 0) ? 28 + intensity : 28;
                this.bsize = (intensity * 2 > 0) ? intensity * 2 : 5;

                var e = new Waveform();
                e.ratio = .3;
                e.y = 108;
                e.graphics.lineStyle(2, 0xffffff, (intensity/5) + .3);
                this.addChild(e);

                this.hit = function() {
                    this.remove();
                }

                this.remove = removeSprite;

                this.enemyCheck = function() {
                    for (var x in gamePlayScene._children) {
                        if (gamePlayScene._children[x].collides == true) {
                            if (this.hitTestObject(gamePlayScene._children[x]) && gamePlayScene._children[x] != gamePlayScene.player) {
                                gamePlayScene._children[x].hit(this.damage);
                                this.remove();
                            }
                        }
                    }
                }

            }
            Bullet.prototype = new Sprite();
            Bullet.prototype.draw = function(e) {
                if (paused) return;
                e.target.graphics.clear();

                e.target.bsize = (intensity * 2 > 0) ? intensity * 2 : 5;
                e.target.damage = (intensity > 0) ? 20 + ( intensity * 2 ) : 20;
                e.target.speed = (intensity > 0) ? 28 + intensity : 28;

                e.target.graphics.beginFill(0x090B1C, 0);
                e.target.graphics.drawRect(0,-20,20,80);
                e.target.graphics.beginFill(0xffffff, 1);
                e.target.graphics.drawRect(0, 16, 8 + (e.target.bsize * 2), 8);

                if (e.target.x > width) {
                    e.target.remove();
                } else {
                    e.target.x += (intensity > 0) ? 16 + intensity : 16;
                }
                e.target.y += enemyCount / 50;
                if (e.target.y > height)
                    e.target.y = 0;
                if (e.target.y < 0)
                    e.target.y = height;
                e.target.enemyCheck();
            }


            function Waveform(width, ratio) {
                Sprite.apply(this);
                this.addEventListener(Event.ENTER_FRAME, this.draw);
                if (ratio == null) ratio = 1;
                this.ratio = ratio;
                if (width != null) this.width = width;
                this.graphics.lineStyle(1.5, 0x898989);

                this.remove = removeSprite;
            }
            Waveform.prototype = new Sprite();
            Waveform.prototype.draw = function(e) {
                if (paused) return;
                if (e.target.width == null) {
                    wavewidth = e.target.parent.GetWidth();
                } else {
                    wavewidth = e.target.width;
                }
                e.target.graphics.clear();
                startX = startY = endY = 0;
                endX = wavewidth;
                var rangeX = endX - startX;
                var rangeY = endY - startY;
                var splits = width/5;
                var xSegmentSize = rangeX / splits;
                var ySegmentSize = rangeY / splits;
                rangeX += xSegmentSize;
                rangeY += ySegmentSize;
                e.target.graphics.moveTo(startX + x, startY + y);
                for (var x=0, y=0; x<rangeX || y<rangeY; x+=xSegmentSize, y+=ySegmentSize) {
                    var wave = WavesArray[~~((x/rangeX) * WavesArray.length)] * e.target.ratio;
                    e.target.graphics.lineTo(startX + x, startY + y + (wave) - (250/2));
                }
            }

function VolumeBars(width) {
}

            var removeSprite = function() {
                this.removeEventListener(Event.ENTER_FRAME,this.draw,false);
                for (var x in this._children) {
                    this._children[x].remove();
                }
                this.parent.removeChild(this);
            }

            var explode = function() {
                var e = new Explosion();
                e.radius = Math.max(this.GetWidth(), this.GetHeight()) / 2;
                e.x = this.x + (this.GetWidth() / 2);
                e.y = this.y + (this.GetHeight() / 2);
                this.parent.addChild(e);
            }


        </script>

        <script type="text/javascript">
            var stage;
            var sp, sideWalls, graph;
            var t1, t2, warningbg;

            var player;
            var lastEnemyAdded = 0;
            var l, r, u, d, fire, pauseKey;

            var bpm = 60;
            var bpmObj = {};
            var lastBeat = 0;
            var beatTolerance = 1;

            var width = 1280;
            var height = 720;
            var warningAccepted = false;
            var t;

            function now() {
                return new Date() * 1;
            }

            function WarningSplash() {
                Sprite.apply(this);
                this.mouseEnabled = true;
                this.mouseChildren = true;

                var f1 = new TextFormat("Arial", 20, 0xffffff);
                this.warningbg = new Sprite();
                this.warningbg.graphics.beginFill(0x000000, .5);
                this.addChild(this.warningbg);
                var t1 = new TextField();
                t1.setTextFormat(f1);
                t1.wordWrap = true;
                t1.text = photosensitiveWarningTitle;
                t1.width = width - 40; 
                t1.height = height - 40;
                this.addChild(t1);
                t1.x = 20;
                t1.y = 40;
                var t2 = new TextField();
                t2.setTextFormat(f1);
                t2.wordWrap = true;
                t2.text = photosensitiveWarning;
                t2.width = width - 40; 
                t2.height = height - 40;
                this.addChild(t2);
                t2.x = 20;
                t2.y = 120;

                this.acceptBtn = new Button("Accept");
                this.acceptBtn.alpha = 0;
                this.addChild(this.acceptBtn);
                this.acceptBtn.addEventListener(MouseEvent.CLICK, hideWarning);
                this.addEventListener(Event.ENTER_FRAME, this.draw);
            }
            WarningSplash.prototype = new Sprite();
            WarningSplash.prototype.draw = function(e) {
                if (paused) return;
                e.target.acceptBtn.x = width / 2 - 100;
                e.target.acceptBtn.y = height - 200;
                e.target.warningbg.graphics.clear();
                e.target.warningbg.graphics.drawRect(0,0,width,height);
            }

            function hideWarning() {
                Tweener.addTween(epilepsyWarningSplash, {alpha:0, time:.5});
                setTimeout(function() {
                    stage.removeChild(epilepsyWarningSplash);
                    showGameSplash();
                }, 500);
            }

            function showGameSplash() {
                if (mainMenuSource) {
                    mainMenuSource.stop(0);
                }
                mainMenuSource = audioContext.createBufferSource();
                mainMenuSource.buffer = mainMenuBuffer;
                mainMenuSource.loop = true;
                mainMenuSource.connect(audioContext.destination);
                setTimeout("mainMenuSource.start(0);", 750);
                for (var x in stage._children) {
                    stage.removeChild(stage._children[x]);
                }
                gameSplash.x = 0;
                gameSplash.y = 0;
                starBg.alpha = 0;
                gameSplash.alpha = 0;
                gameSplash.startButton.alpha = 0;
                stage.addChild(gameSplash);
                if ($.inArray(starBg, stage._children) == -1) {
                    stage.addChild(starBg);
                }
                Tweener.addTween(starBg, {alpha:1, time:5});
                Tweener.addTween(gameSplash, {alpha:1, time:5, delay:1});
                Tweener.addTween(gameSplash.startButton, {alpha:1, time:5, delay:3});
            }

            function StarBackground() {
                Sprite.apply(this);
                this.addEventListener(Event.ENTER_FRAME, this.draw);
                this.numStars = 75;
                while (this._children.length < this.numStars) {
                    var s = new Star(Math.random() * 10 + .1);
                    s.x = Math.random() * width;
                    s.y = Math.random() * height;
                    this.addChild(s);
                }
            }
            StarBackground.prototype = new Sprite();
            StarBackground.prototype.draw = function(e) {
                if (paused) return;
                e.target.numStars = Math.max(~~(height * width / 20000), ~~(intensity * 10));
                if (e.target._children.length < e.target.numStars) {
                    e.target.addChild(new Star(Math.random() * 5 + .1));
                }
            }

            function Star(speed) {
                Sprite.apply(this);
                this.addEventListener(Event.ENTER_FRAME, this.draw);
                this.speed = speed;
                this.initialSpeed = speed;
                this.x = width;
                this.y = Math.random() * height;
                this.remove = removeSprite;
            }
            Star.prototype = new Sprite();
            Star.prototype.draw = function(e) {
                if (paused) return;
                e.target.x -= e.target.speed;
                var boost = (intensity > 0) ? (intensity / 3) : 0;
                e.target.y += enemyCount / 25;
                e.target.x -= boost * 3;
                e.target.graphics.clear();
                e.target.graphics.beginFill(0xffffff, e.target.speed / 5);
                e.target.graphics.drawRect(0,0,e.target.initialSpeed / 5 + 2 + boost * 3,e.target.initialSpeed / 5 + 2);
                if (e.target.x < 0)
                    e.target.remove();
                if (e.target.y > height)
                    e.target.y = 0;
                if (e.target.y < 0)
                    e.target.y = height;
            }

            function Logo() {
                Sprite.apply(this);
                this.addEventListener(Event.ENTER_FRAME, this.draw);

                this.lastFrameFlag = 0;
                this.nextBlink = now();
                this.logoData = new BitmapData("./img/logo.png", 1);
                this.logoDistortData = new BitmapData("./img/logo-distorted.png", 1);
                this.logo = new Bitmap(this.logoData);
                this.logo2 = new Bitmap(this.logoDistortData);
                this.logo2.alpha = 0;

                this.addChild(this.logo2);
                this.addChild(this.logo);
            }
            Logo.prototype = new Sprite();
            Logo.prototype.draw = function(e) {
                if (paused) return;
                if (e.target.nextBlink < now()) {
                    e.target.logo.alpha = Math.random() * .25;
                    e.target.logo2.alpha = Math.random() * .75;
                    e.target.nextBlink = now() + Math.random() * 6000;
                    e.target.lastFrameFlag = 0;
                } else {
                    if (e.target.lastFrameFlag < Math.random() * 5) {
                        e.target.lastFrameFlag += 1;
                    } else {
                        e.target.logo.alpha = 1;
                        e.target.logo2.alpha = 0;
                    }
                }
            }

            function GameSplash() {
                Sprite.apply(this);
                this.addEventListener(Event.ENTER_FRAME, this.draw);

                this.logo = new Logo();
                this.startButton = new Button("Start");
                this.startButton.alpha = 0;

                this.addChild(this.startButton);
                this.addChild(this.logo);

                this.startButton.addEventListener(MouseEvent.CLICK, showMenu);
            }
            GameSplash.prototype = new Sprite();
            GameSplash.prototype.draw = function(e) {
                if (paused) return;
                e.target.logo.x = (width / 2) - (e.target.logo.GetWidth() / 2);
                e.target.logo.y = (height / 4) - (e.target.logo.GetHeight() / 4);
                e.target.startButton.x = (width / 2) - (e.target.startButton.GetWidth() / 2);
                e.target.startButton.y = (3 * height / 4) - (e.target.startButton.GetHeight() / 4);
            }

            function showMenu() {
                mainMenuScene.x = width;
                stage.addChild(mainMenuScene);
                Tweener.addTween(gameSplash, {x:-width, time:3, transition:"easeInOutSine"})
                setTimeout(function() {
                    stage.removeChild(gameSplash);
                }, 3000);
                Tweener.addTween(mainMenuScene, {x:0, time:3, transition:"easeInOutSine"});
            }

            function MainMenu() {
                Sprite.apply(this);
                this.addEventListener(Event.ENTER_FRAME, this.draw);
                this.uploadSongButton = new Button("Choose Song");
                this.addChild(this.uploadSongButton);

                this.uploadSongButton.addEventListener(MouseEvent.MOUSE_OVER, function() { canUpload = true; });
                this.uploadSongButton.addEventListener(MouseEvent.MOUSE_OUT, function() { canUpload = false; });
                this.addEventListener(Event.ENTER_FRAME, this.draw);
            }
            MainMenu.prototype = new Sprite();
            MainMenu.prototype.draw = function(e) {
                if (paused) return;
                e.target.uploadSongButton.x = width/2 - e.target.uploadSongButton.GetWidth()/2;
                e.target.uploadSongButton.y = height/2 - e.target.uploadSongButton.GetHeight()/2;
            }

            function LoadingScreen() {
                this.mouseEnabled = false;
                Sprite.apply(this);
                this.logo = new Logo();
                this.addChild(this.logo);

            }
            LoadingScreen.prototype = new Sprite();
            
            function showLoadingScreen() {
                loadingScene.alpha = 0;
                stage.addChild(loadingScene);
                Tweener.addTween(loadingScene, {alpha:1, time:1});
                Tweener.addTween(mainMenuScene, {alpha:0, time:1});
                setTimeout(function() {
                    stage.removeChild(mainMenuScene);
                }, 1000);
            }

            function showGameScreen() {
                gamePlayScene.alpha = 0;
                stage.addChild(gamePlayScene);
                Tweener.addTween(loadingScene, {alpha:0, time:1});
                setTimeout(function() {
                    stage.removeChild(loadingScene);
                }, 1000);
                Tweener.addTween(gamePlayScene, {alpha:1, time:1});
                $("canvas").addClass("no-cursor");
            }

            function GamePlay() {
                Sprite.apply(this);
                this.mouseEnabled = true;
                this.performanceGraph = [];
                this.score = 0;
                this.addEventListener(Event.ENTER_FRAME, this.draw);

                stage.addEventListener(MouseEvent.MOUSE_DOWN, function() { fire = true; });
                stage.addEventListener(MouseEvent.MOUSE_UP, function() { fire = false; });
                stage.addEventListener(KeyboardEvent.KEY_DOWN, onKeydown);
                stage.addEventListener(KeyboardEvent.KEY_UP  , onKeyup);

                this.sidewalls = new Sprite();
                this.waveforms = new Sprite();
                this.scoreBoard = new TextField();
                this.effects = new Sprite();
                this.effects.offset = 0;
                this.effects.offsetTarget = 0;
                this.effects.colorBlue = 0;
                this.effects.targetColorBlue = 0;
                this.effects.colorRed = 0;
                this.effects.targetColorRed = 0;

                this.scoreBoard.setTextFormat(new TextFormat("Arial", 25, 0xffffff, false, false, "center"));

                this.player = new Player();
                this.reset = function() {
                    this.player.x = 100;
                    this.player.y = height / 2 - 16;
                    this.performanceGraph = [];
                    this.score = 0;
                    this.player.reset();
                }
                this.reset();

                this.mousemove = function(e) {
                    this.player.x = stage.mouseX;
                    this.player.y = stage.mouseY;
                }

                this.addChild(this.sidewalls);
                this.addChild(this.effects);
                this.addChild(this.waveforms);
                this.addChild(this.scoreBoard);
                this.addChild(this.player);
            }
            GamePlay.prototype = new Sprite();
            GamePlay.prototype.draw = function(e) {
                if (paused) return;
                if (pauseKey)
                    pause();
                updateSoundData();

                e.target.scoreBoard.text = "" + ~~e.target.player.displayScore;
                e.target.scoreBoard.height = e.target.scoreBoard.textHeight;
                e.target.scoreBoard.width = e.target.scoreBoard.textWidth;
                e.target.scoreBoard.x = width / 2;
                e.target.scoreBoard.y = height - 36;

                // Effect Lines
                e.target.effects.graphics.clear();
                e.target.effects.graphics.lineStyle(2.5, RGBToHex(e.target.effects.colorRed, 45, e.target.effects.colorBlue), Math.min(.75, Math.max(0, intensity/20) + .001));
                for (var y=0; y<height; y+= 50) {
                    e.target.effects.graphics.moveTo(0, y - e.target.effects.offset % 50);
                    e.target.effects.graphics.lineTo(width, y - e.target.effects.offset % 50);
                }

                // Sidewalls
                e.target.sidewalls.graphics.clear();
                e.target.sidewalls.graphics.lineStyle(sidewallIntensity, 0xffffff, .50);

                sidewallIntensity /= 2;
                e.target.sidewalls.graphics.moveTo(0, sidewallIntensity);
                e.target.sidewalls.graphics.lineTo(width, sidewallIntensity);
                e.target.sidewalls.graphics.moveTo(width - sidewallIntensity, sidewallIntensity * 2);
                e.target.sidewalls.graphics.lineTo(width - sidewallIntensity, height);
                e.target.sidewalls.graphics.moveTo(width - sidewallIntensity * 2, height - sidewallIntensity);
                e.target.sidewalls.graphics.lineTo(sidewallIntensity * 2, height - sidewallIntensity);
                e.target.sidewalls.graphics.moveTo(sidewallIntensity, height);
                e.target.sidewalls.graphics.lineTo(sidewallIntensity, sidewallIntensity * 2);

                e.target.waveforms.graphics.clear();
                e.target.waveforms.graphics.lineStyle(1.5, 0x898989);
                drawWaveform(0, height/2, width, height/2, WavesArray, e.target.waveforms);
                e.target.waveforms.graphics.lineStyle(2, 0x393939, (intensity/20) + .01);
                drawWaveform(0, height/4, width, height/4, WavesArray, e.target.waveforms);
                e.target.waveforms.graphics.lineStyle(2, 0x393939, (intensity/20) + .01);
                drawWaveform(0, 3*height/4, width, 3*height/4, WavesArray, e.target.waveforms);
                e.target.waveforms.graphics.lineStyle(7, 0x393939, (intensity/20) + .01);
                drawWaveform(0, (height/2)-4, width, (height/2)-4, WavesArray, e.target.waveforms);
                drawWaveform(0, (height/2)+4, width, (height/2)+4, WavesArray, e.target.waveforms);
                e.target.waveforms.graphics.lineStyle(7, 0xffffff, (intensity/20) + .01);
            }

            var logo;
            var epilepsyWarningSplash, gameSplash, starBg, mainMenuScene, loadingScene;
            var canUpload = false;
            var canFullscreen = false;
            function Init() {
                // Preload Audio Buffers
                preLoadBuffers();

                // Create Global Stage
                stage = new Stage("canvas");
                // stage.stageHeight = height;
                // stage.stageWidth = width;
                height = stage.stageHeight;
                width = stage.stageWidth

                // Create Scenes
                epilepsyWarningSplash = new WarningSplash();
                gameSplash = new GameSplash();
                starBg = new StarBackground();
                mainMenuScene = new MainMenu();
                gamePlayScene = new GamePlay();
                loadingScene = new LoadingScreen();

                // Add Initial Scene
                stage.addChild(epilepsyWarningSplash);

                // Create Event Listeners
                $("#canvas").click(function() {
                    if (canUpload) {
                        document.getElementById("fileUploadForm").click();
                    } else if (canFullscreen) {
                        if (screenfull.enabled) {
                            screenfull.request();
                        }
                    }
                })
                stage.addEventListener(Event.ENTER_FRAME, Draw);
                stage.addEventListener(MouseEvent.MOUSE_MOVE, function(e){ gamePlayScene.mousemove(e) } );
            }

            function Draw() {
                height = stage.stageHeight;
                width = stage.stageWidth
            }

            var totalIntensity = 0;
            var lastIntensity = 0;
            var lastUpdate = now();
            var step = 0;
            var intensity = 0;
            var sidewallIntensity = 0;
            var WavesArray = [127];
            var FFTArray = [0];
            var deincrementEnemyCount = true;

            function updateSoundData() {
                if (songPlaying) {
                    var minusEnemy = ~~(now() / 2500) % 2 == 0;
                    if (minusEnemy && deincrementEnemyCount) {
                        enemyCount -= .5;
                        deincrementEnemyCount = false;
                    }
                    if (!minusEnemy) {
                        deincrementEnemyCount = true;
                    }
                    FFTArray = new Float32Array(1024);
                    WavesArray = new Uint8Array(1024);
                    analyser.getFloatFrequencyData(FFTArray);
                    analyser.getByteTimeDomainData(WavesArray);

                    intensity = 0;
                    for (var x=0; x<1024; x+=1) {
                        intensity += Math.abs(FFTArray[x]) - 50;
                    }
                    intensity /= 1024;
                    intensity *= -1;
                    if (lastUpdate + 5 < now() || true) {
                        lastUpdate = now();
                        //graph.graphics.lineTo(step, height/2 + ((intensity - lastIntensity) * 8));
                        sidewallIntensity = ((intensity - lastIntensity) * 3) - 12;
                        lastIntensity = intensity;
                        step += 8;
                        if (step > width) {
                            step=0;
                        }
                        gamePlayScene.effects.offsetTarget = enemyCount * 50 + Math.max(0, intensity) * 2;
                        gamePlayScene.effects.targetColorRed = Math.max(0, Math.min(220, sidewallIntensity * 30 * enemyCount));
                        gamePlayScene.effects.targetColorBlue = Math.max(0, 150 - Math.max(0, sidewallIntensity * 10 * enemyCount));
                    }
                    if (sidewallIntensity > 0) {
                        Tweener.addTween(gamePlayScene.effects, {offset:gamePlayScene.effects.offsetTarget, time:5});
                        Tweener.addTween(gamePlayScene.effects, {colorRed:gamePlayScene.effects.targetColorRed, time:5});
                        Tweener.addTween(gamePlayScene.effects, {colorBlue:gamePlayScene.effects.targetColorBlue, time:5});
                        beat = beatTolerance * (~~((now() - lastBeat) / beatTolerance));
                        lastBeat = now();
                        if (!bpmObj.hasOwnProperty(beat))
                            bpmObj[beat] = 0;
                        if (beat > 100)
                            bpmObj[beat] += 1;
                        highScore = 0;
                        for (b in bpmObj) {
                            if (bpmObj[b] > highScore) {
                                highScore = (bpmObj[b]);
                                bpm = 60000 / (b * 1);
                            }
                        }
                    }
                    if (Math.abs(lastEnemyAdded - now()) > 60000 / bpm) {
                        lastEnemyAdded = now();
                        console.log("new Enemy");
                        if (sidewallIntensity > 20 ) {
                            en = new Enemy();
                            en.x = width;
                            en.y = Math.random() * height;
                            gamePlayScene.addChild(en);
                        } else if (intensity > -36) {
                            en = new Enemy();
                            en.x = width;
                            en.y = Math.random() * height;
                            gamePlayScene.addChild(en);
                        } else if (sidewallIntensity > 15) {
                            en = new Enemy();
                            en.x = width;
                            en.y = Math.random() * height;
                            gamePlayScene.addChild(en);
                        }
                    }
                    if (sidewallIntensity > 20) sidewallIntensity = 20;
                    if (sidewallIntensity < 0) sidewallIntensity = 0;
                    intensity += 40;
                    totalIntensity += sidewallIntensity - 1;
                }

            }


            /*
               Key press events
           */

            function onKeydown(e)
            { 
               // console.log(e.keyCode);
               if(e.keyCode == 37 || e.keyCode == 65) l = true;
               if(e.keyCode == 38 || e.keyCode == 87) u = true;
               if(e.keyCode == 39 || e.keyCode == 68) r = true;
               if(e.keyCode == 40 || e.keyCode == 83) d = true;
               if(e.keyCode == 32) fire = true;
               if(e.keyCode == 27) pauseKey = true;
            }

            function onKeyup(e)
            {
               if(e.keyCode == 37 || e.keyCode == 65) l = false;
               if(e.keyCode == 38 || e.keyCode == 87) u = false;
               if(e.keyCode == 39 || e.keyCode == 68) r = false;
               if(e.keyCode == 40 || e.keyCode == 83) d = false;
               if(e.keyCode == 32) fire = false;
               if(e.keyCode == 27) pauseKey = false;
            }

            function drawWaveform(startX, startY, endX, endY, Waves, displayObj, ratio) {
                if (ratio == null) {
                    ratio = 1;
                }
                var rangeX = endX - startX;
                var rangeY = endY - startY;
                var splits = width/5;
                var xSegmentSize = rangeX / splits;
                var ySegmentSize = rangeY / splits;
                rangeX += xSegmentSize;
                rangeY += ySegmentSize;
                displayObj.graphics.moveTo(startX + x, startY + y);
                for (var x=0, y=0; x<rangeX || y<rangeY; x+=xSegmentSize, y+=ySegmentSize) {
                    var wave = Waves[~~((x/rangeX) * Waves.length)] * ratio;
                    displayObj.graphics.lineTo(startX + x, startY + y + (wave) - (250/2));
                }
            }

            var RGBToHex = function(r,g,b){
                var bin = r << 16 | g << 8 | b;
                return parseInt(bin);
                return (function(h){
                    return new Array(7-h.length).join("0")+h
                })(bin.toString(16).toUpperCase())
            }

            window.requestAnimFrame = (function(){
              return  window.requestAnimationFrame       ||
                      window.webkitRequestAnimationFrame ||
                      window.mozRequestAnimationFrame    ||
                      function( callback ){
                        window.setTimeout(callback, 1000 / 60);
                      };
            })();

        </script>
    </head>
    <body onload="Init()">
        <canvas id="canvas"></canvas><br><br>
        <input type="file" name="file" id="fileUploadForm"><br>
    </body>
</html>
