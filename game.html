<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Music Wars</title>
        <style type="text/css">
            html, body, canvas {
                margin: 0px;
                padding: 0px;
                overflow: hidden;
                background: #090B1C;
            }
            #fileUploadForm {
                position: absolute;
                top: 0px;
                left: 0px;
            }
        </style>
        <script type="text/javascript" src="./ivank-0.72.js"></script>
        <script type="text/javascript" src="./jquery-2.0.0.min.js"></script>

        <script type="text/javascript">

            version = "0.2a";
            author = "Britt Gresham";

            $(document).ready(function() {
                var filePrompt = document.getElementById('fileUploadForm');
                filePrompt.addEventListener('change', getSongFromComputer, false);
            });
            var audioContext = new webkitAudioContext();
            var songPlaying = false;

            function getSongFromComputer(eventObj) {
                var filename = eventObj.target.files[0];
                var reader = new FileReader();
                reader.onload = function() {
                    audioContext.decodeAudioData(reader.result, function(buffer) {
                        var audioBuffer = buffer;
                        playBuffer(audioBuffer);
                    });
                };
                reader.readAsArrayBuffer(filename);
            }

            function playBuffer(audioBuffer) {
                source = audioContext.createBufferSource();
                analyser = audioContext.createAnalyser();
                delay = audioContext.createDelay();
                
                source.buffer = audioBuffer;
                source.playbackRate.value = 1;

                delay.delayTime.value = .06;

                analyser.smoothingTimeConstant = 0;
                
                source.connect(analyser);
                analyser.connect(delay);
                delay.connect(audioContext.destination);
                
                source.noteOn(0);
                songPlaying = true;
                lastBeat = new Date() * 1;
            }



        </script>

        <script type="text/javascript">
            var stage;
            var sp, sideWalls, graph;

            var bpm = 0;
            var bpmObj = {};
            var lastBeat = 0;
            var beatTolerance = 30;

            var width = 1280;
            var height = 720;

            function Init() {
                stage = new Stage("canvas");

                sp = new Sprite();
                sideWalls = new Sprite();
                graph = new Sprite();

                graph.graphics.lineStyle(3, 0xff0000, 1);
                graph.graphics.moveTo(step, height/2);

                stage.addChild(sp);
                stage.addChild(sideWalls);
                stage.addChild(graph);
                stage.stageHeight = height;
                stage.stageWidth = width;

                stage.addEventListener(Event.ENTER_FRAME, Draw);
            }

            var totalIntensity = 0;
            var lastIntensity = 0;
            var lastUpdate = new Date() * 1;
            var step = 0;
            var intensity = 0;
            var sidewallIntensity = 0;

            var Draw = function() {

                /*
                 *  Calculate Waveforms
                 */
                var WavesArray = [127];
                var FFTArray = [0];

                if (songPlaying) {
                    FFTArray = new Float32Array(1024);
                    WavesArray = new Uint8Array(1024);
                    analyser.getFloatFrequencyData(FFTArray);
                    analyser.getByteTimeDomainData(WavesArray);

                    intensity = 0;
                    for (var x=0; x<1024; x+=1) {
                        intensity += Math.abs(FFTArray[x]) - 50;
                    }
                    intensity /= 1024;
                    intensity *= -1;
                    if (lastUpdate + 5 < new Date() * 1 || true) {
                        lastUpdate = new Date() * 1;
                        graph.graphics.lineTo(step, height/2 + (intensity - lastIntensity));
                        sidewallIntensity = ((intensity - lastIntensity) * 3) - 12;
                        lastIntensity = intensity;
                        step += 5;
                        if (step > width) {
                            step=0;
                            graph.graphics.clear();
                            graph.graphics.moveTo(0,height/2);
                        }
                    }
                    if (sidewallIntensity > - 0) {
                        beat = beatTolerance * (~~((new Date() * 1 - lastBeat) / beatTolerance));
                        lastBeat = new Date() * 1;
                        if (!bpmObj.hasOwnProperty(beat))
                            bpmObj[beat] = 0;
                        if (beat > 0)
                            bpmObj[beat] += 1;
                        highScore = 0;
                        for (b in bpmObj) {
                            if (bpmObj[b] > highScore) {
                                highScore = (bpmObj[b]);
                                bpm = 60000 / (b * 1);
                            }
                        }
                    }
                    if (sidewallIntensity > 20) sidewallIntensity = 20;
                    if (sidewallIntensity < 0) sidewallIntensity = 0;
                    intensity += 40;

                }
                /*
                 *  Draw Side Walls
                 */
                sideWalls.graphics.clear();
                sideWalls.graphics.lineStyle(sidewallIntensity, 0xffffff, .50);
                sidewallIntensity /= 2;
                sideWalls.graphics.moveTo(0, sidewallIntensity);
                sideWalls.graphics.lineTo(width, sidewallIntensity);
                sideWalls.graphics.moveTo(width - sidewallIntensity, sidewallIntensity * 2);
                sideWalls.graphics.lineTo(width - sidewallIntensity, height);
                sideWalls.graphics.moveTo(width - sidewallIntensity * 2, height - sidewallIntensity);
                sideWalls.graphics.lineTo(sidewallIntensity * 2, height - sidewallIntensity);
                sideWalls.graphics.moveTo(sidewallIntensity, height);
                sideWalls.graphics.lineTo(sidewallIntensity, sidewallIntensity * 2);


                /*
                 *  Draw Waveform
                 */

                var drawWaveform = function(startX, startY, endX, endY, Waves, displayObj) {
                    var rangeX = endX - startX;
                    var rangeY = endY - startY;
                    var splits = width/5;
                    var xSegmentSize = rangeX / splits;
                    var ySegmentSize = rangeY / splits;
                    rangeX += xSegmentSize;
                    rangeY += ySegmentSize;

                    sp.graphics.moveTo(startX + x, startY + y);

                    for (var x=0, y=0; x<rangeX || y<rangeY; x+=xSegmentSize, y+=ySegmentSize) {
                        var wave = Waves[~~((x/rangeX) * Waves.length)];
                        sp.graphics.lineTo(startX + x, startY + y + (wave) - (250/2));
                    }
                }

                sp.graphics.clear();
                sp.graphics.lineStyle(.5, 0xffffff);

                drawWaveform(0, height/2, width, height/2, WavesArray, sp);

                sp.graphics.lineStyle(2, 0xffffff, (intensity/20) + .01);
                drawWaveform(0, height/4, width, height/4, WavesArray, sp);

                sp.graphics.lineStyle(2, 0xffffff, (intensity/20) + .01);
                drawWaveform(0, 3*height/4, width, 3*height/4, WavesArray, sp);

                sp.graphics.lineStyle(7, 0xffffff, (intensity/20) + .01);
                drawWaveform(0, (height/2)-4, width, (height/2)-4, WavesArray, sp);
                drawWaveform(0, (height/2)+4, width, (height/2)+4, WavesArray, sp);
            }


            window.requestAnimFrame = (function(){
              return  window.requestAnimationFrame       ||
                      window.webkitRequestAnimationFrame ||
                      window.mozRequestAnimationFrame    ||
                      function( callback ){
                        window.setTimeout(callback, 1000 / 60);
                      };
            })();

        </script>
    </head>
    <body onload="Init()">
        <canvas id="canvas"></canvas><br><br>
        <input type="file" name="file" id="fileUploadForm"><br>
    </body>
</html>
