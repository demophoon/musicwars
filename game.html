<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Music Wars</title>
        <style type="text/css">
            html, body, canvas {
                margin: 0px;
                padding: 0px;
                overflow: hidden;
                background: #090B1C;
            }
            #fileUploadForm {
                position: absolute;
                top: 0px;
                left: 0px;
            }
        </style>
        <script type="text/javascript" src="./ivank-0.72.js"></script>
        <script type="text/javascript" src="./jquery-2.0.0.min.js"></script>

        <script type="text/javascript">

            version = "0.4a";
            author = "Britt Gresham";

            var photosensitiveWarningTitle = "PHOTOSENSITIVE WARNING: READ BEFORE PLAYING!";
            var photosensitiveWarning = "A very small percentage of individuals may experience epileptic seizures" + 
            " when exposed to certain light patterns or flashing lights.\nExposure to certain patterns or backgrounds" +
            " on a computer screen, or while playing video games, may induce an epileptic seizure in these individuals.\n" +
            "Certain conditions may induce previously undetected epileptic symptoms even in persons who have no history " +
            "of prior seizures or epilepsy.\n\nIf you, or anyone in your family, have an epileptic condition, consult your physician" + 
            " prior to playing. If you experience any of the following symptoms while playing a video or computer game -- " + 
            "dizziness, altered vision, eye or muscle twitches, loss of awareness, disorientation, any involuntary movement, or " + 
            "convulsions -- IMMEDIATELY discontinue use and consult your physician before resuming play."

            $(document).ready(function() {
                var filePrompt = document.getElementById('fileUploadForm');
                filePrompt.addEventListener('change', getSongFromComputer, false);
            });
            var audioContext = new webkitAudioContext();
            var songPlaying = false;

            function getSongFromComputer(eventObj) {
                var filename = eventObj.target.files[0];
                var reader = new FileReader();
                reader.onload = function() {
                    audioContext.decodeAudioData(reader.result, function(buffer) {
                        var audioBuffer = buffer;
                        playBuffer(audioBuffer);
                    });
                };
                reader.readAsArrayBuffer(filename);
            }

            function playBuffer(audioBuffer) {
                if (!warningAccepted) return;
                source = audioContext.createBufferSource();
                analyser = audioContext.createAnalyser();
                delay = audioContext.createDelay();
                
                source.buffer = audioBuffer;
                source.playbackRate.value = 1;

                delay.delayTime.value = .06;

                analyser.smoothingTimeConstant = 0;
                
                source.connect(analyser);
                analyser.connect(delay);
                delay.connect(audioContext.destination);
                
                source.noteOn(0);
                songPlaying = true;
                bpm = 0;
                bpmObj = {};
                lastBeat = new Date() * 1;
            }



        </script>

        <script type="text/javascript">
            function Button(name)	// extends Sprite
            {
                Sprite.apply(this);
                this.buttonMode = true;
                this.mouseChildren = false;
                this.name = name;
                
                this.graphics.beginFill(0x00ddff);
                this.graphics.drawRect(0, 0, 150, 35);
                
                
                this.bg = new Sprite();		// bg is a layer with dark blue rectangle
                this.bg.graphics.beginFill(0x0066dd);
                this.bg.graphics.drawRect(0, 0, 150, 35);
                this.addChild(this.bg);
                
                
                var t = new TextField();
                t.setTextFormat(Button.tFormat);
                t.text = name; t.x = 20; t.y = 3;
                t.width = t.textWidth; t.height = t.textHeight;
                this.addChild(t);
                
                
                this.addEventListener(MouseEvent.MOUSE_OVER, this.onMOv);
                this.addEventListener(MouseEvent.MOUSE_OUT , this.onMOu);
            }
            Button.prototype = new Sprite();

            //	static variable
            Button.tFormat    = new TextFormat("Arial", 25, 0xffffff);

            //	methods
            Button.prototype.onMOv = function(e) { e.target.bg.visible = false; }
            Button.prototype.onMOu = function(e) { e.target.bg.visible = true; }
        </script>

        <script type="text/javascript">
            var stage;
            var sp, sideWalls, graph;
            var t1, t2, warningbg;

            var player;
            var bullets = [];
            var lastAddBullet = 0;
            var l, r, u, d, fire;

            var bpm = 0;
            var bpmObj = {};
            var lastBeat = 0;
            var beatTolerance = 10;

            var width = 1280;
            var height = 720;
            var warningAccepted = false;

            function Init() {
                stage = new Stage("canvas");

                sp = new Sprite();
                weapon = new Sprite();
                sideWalls = new Sprite();
                graph = new Sprite();
                player = new Sprite();

                var f1 = new TextFormat("Arial", 20, 0xffffff);
                warningbg = new Sprite();
                warningbg.graphics.beginFill(0x000000, .5);
                warningbg.graphics.drawRect(0,0,width,height);
                stage.addChild(warningbg);
                t1 = new TextField();
                t1.setTextFormat(f1);
                t1.wordWrap = true;
                t1.text = photosensitiveWarningTitle;
                t1.width = width - 40; 
                t1.height = height - 40;
                stage.addChild(t1);
                t1.x = 20;
                t1.y = 40;
                t2 = new TextField();
                t2.setTextFormat(f1);
                t2.wordWrap = true;
                t2.text = photosensitiveWarning;
                t2.width = width - 40; 
                t2.height = height - 40;
                stage.addChild(t2);
                t2.x = 20;
                t2.y = 120;

                acceptBtn = new Button("Accept");
                acceptBtn.x = width / 2 - 100;
                acceptBtn.y = height - 200;
                stage.addChild(acceptBtn);
                acceptBtn.addEventListener(MouseEvent.CLICK, hideWarning);


                weapon.visible = false;
                sideWalls.visible = false;
                graph.visible = false;
                player.visible = false;

                graph.graphics.lineStyle(3, 0xff0000, 1);
                graph.graphics.moveTo(step, height/2);

                stage.addChild(sp);
                stage.addChild(weapon);
                stage.addChild(sideWalls);
                stage.addChild(graph);
                stage.addChild(player);

                player.x = 100;
                player.y = height / 2 - 16;

                stage.stageHeight = height;
                stage.stageWidth = width;

                stage.addEventListener(KeyboardEvent.KEY_DOWN, onKeydown);
                stage.addEventListener(KeyboardEvent.KEY_UP  , onKeyup);
                stage.addEventListener(Event.ENTER_FRAME, Draw);

                player.graphics.beginFill(0xffffff, 1);
                player.graphics.drawRect(0,0,10,36);
                player.graphics.drawRect(10,10,10,16);
                player.graphics.drawRect(20,14,5,1);
                player.graphics.drawRect(20,21,5,1);

            }

            var totalIntensity = 0;
            var lastIntensity = 0;
            var lastUpdate = new Date() * 1;
            var step = 0;
            var intensity = 0;
            var sidewallIntensity = 0;

            var Draw = function() {

                /*
                 *  Calculate Waveforms
                 */

                var WavesArray = [127];
                var FFTArray = [0];

                if (songPlaying) {
                    FFTArray = new Float32Array(1024);
                    WavesArray = new Uint8Array(1024);
                    analyser.getFloatFrequencyData(FFTArray);
                    analyser.getByteTimeDomainData(WavesArray);

                    intensity = 0;
                    for (var x=0; x<1024; x+=1) {
                        intensity += Math.abs(FFTArray[x]) - 50;
                    }
                    intensity /= 1024;
                    intensity *= -1;
                    if (lastUpdate + 5 < new Date() * 1 || true) {
                        lastUpdate = new Date() * 1;
                        graph.graphics.lineTo(step, height/2 + ((intensity - lastIntensity) * 8));
                        sidewallIntensity = ((intensity - lastIntensity) * 3) - 12;
                        lastIntensity = intensity;
                        step += 8;
                        if (step > width) {
                            step=0;
                            graph.graphics.clear();
                            graph.graphics.moveTo(0,height/2);
                        }
                    }
                    if (sidewallIntensity > - 0) {
                        beat = beatTolerance * (~~((new Date() * 1 - lastBeat) / beatTolerance));
                        lastBeat = new Date() * 1;
                        if (!bpmObj.hasOwnProperty(beat))
                            bpmObj[beat] = 0;
                        if (beat > 100)
                            bpmObj[beat] += 1;
                        highScore = 0;
                        for (b in bpmObj) {
                            if (bpmObj[b] > highScore) {
                                highScore = (bpmObj[b]);
                                bpm = 60000 / (b * 1);
                            }
                        }
                    }
                    if (sidewallIntensity > 20) sidewallIntensity = 20;
                    if (sidewallIntensity < 0) sidewallIntensity = 0;
                    intensity += 40;

                }

                /*
                 *  Player Movement
                 */

                var movementBonus = 1;
                if (intensity / 4 > 0) {
                    movementBonus += intensity / 4;
                }
                movementBonus = movementBonus / 12 * 12;
                if (u) player.y -= 8 + movementBonus;
                if (d) player.y += 8 + movementBonus;
                if (l) player.x -= 8 + movementBonus;
                if (r) player.x += 8 + movementBonus;

                if (player.x > width - 20) player.x = width - 20;
                if (player.x < 0) player.x = 0;
                if (player.y > height - 36) player.y = height - 36;
                if (player.y < 0) player.y = 0;
                if (fire) addBullet(player.x, player.y);


                /*
                 *  Draw Side Walls
                 */
                sideWalls.graphics.clear();
                sideWalls.graphics.lineStyle(sidewallIntensity, 0xffffff, .50);
                sidewallIntensity /= 2;
                sideWalls.graphics.moveTo(0, sidewallIntensity);
                sideWalls.graphics.lineTo(width, sidewallIntensity);
                sideWalls.graphics.moveTo(width - sidewallIntensity, sidewallIntensity * 2);
                sideWalls.graphics.lineTo(width - sidewallIntensity, height);
                sideWalls.graphics.moveTo(width - sidewallIntensity * 2, height - sidewallIntensity);
                sideWalls.graphics.lineTo(sidewallIntensity * 2, height - sidewallIntensity);
                sideWalls.graphics.moveTo(sidewallIntensity, height);
                sideWalls.graphics.lineTo(sidewallIntensity, sidewallIntensity * 2);


                /*
                 *  Draw Waveform
                 */

                sp.graphics.clear();
                sp.graphics.lineStyle(1.5, 0x898989);
                drawWaveform(0, height/2, width, height/2, WavesArray, sp);

                sp.graphics.lineStyle(2, 0x393939, (intensity/20) + .01);
                drawWaveform(0, height/4, width, height/4, WavesArray, sp);

                sp.graphics.lineStyle(2, 0x393939, (intensity/20) + .01);
                drawWaveform(0, 3*height/4, width, 3*height/4, WavesArray, sp);

                sp.graphics.lineStyle(7, 0x393939, (intensity/20) + .01);
                drawWaveform(0, (height/2)-4, width, (height/2)-4, WavesArray, sp);
                drawWaveform(0, (height/2)+4, width, (height/2)+4, WavesArray, sp);

                sp.graphics.lineStyle(7, 0xffffff, (intensity/20) + .01);

                /*
                 *  Draw Weapons
                 */
                weapon.graphics.clear();
                for (var x in bullets) {
                    if (bullets[x]['x'] > width) {
                        bullets.splice(x,1);
                    } else {
                        bullets[x]['x'] += 16;
                        if (intensity / 2 > 0) {
                            bullets[x]['x'] += intensity / 2;
                        }
                        var bsize = intensity;
                        if (bsize < 5) {
                            bsize = 5;
                        }
                        weapon.graphics.lineStyle(2, 0xffffff, (intensity/5) + .3);
                        drawWaveform(bullets[x]['x'], bullets[x]['y'] + 84 + 16, bullets[x]['x'] + (bsize * 2), bullets[x]['y'] + 84 + 16, WavesArray, weapon, .35);
                        weapon.graphics.beginFill(0xffffff, 1);
                        weapon.graphics.drawRect(bullets[x]['x'], bullets[x]['y'] + 16, 8 + (bsize * 2), 8);
                    }
                }
            }

            /*
               Key press events
           */

            function onKeydown(e)
            { 
                if (!warningAccepted) return;
               // console.log(e.keyCode);
               if(e.keyCode == 37 || e.keyCode == 65) l = true;
               if(e.keyCode == 38 || e.keyCode == 87) u = true;
               if(e.keyCode == 39 || e.keyCode == 68) r = true;
               if(e.keyCode == 40 || e.keyCode == 83) d = true;
               if(e.keyCode == 32) fire = true;
            }

            function onKeyup(e)
            {
               if(e.keyCode == 37 || e.keyCode == 65) l = false;
               if(e.keyCode == 38 || e.keyCode == 87) u = false;
               if(e.keyCode == 39 || e.keyCode == 68) r = false;
               if(e.keyCode == 40 || e.keyCode == 83) d = false;
               if(e.keyCode == 32) fire = false;
            }

            function drawWaveform(startX, startY, endX, endY, Waves, displayObj, ratio) {
                if (ratio == null) {
                    ratio = 1;
                }
                var rangeX = endX - startX;
                var rangeY = endY - startY;
                var splits = width/5;
                var xSegmentSize = rangeX / splits;
                var ySegmentSize = rangeY / splits;
                rangeX += xSegmentSize;
                rangeY += ySegmentSize;
                displayObj.graphics.moveTo(startX + x, startY + y);
                for (var x=0, y=0; x<rangeX || y<rangeY; x+=xSegmentSize, y+=ySegmentSize) {
                    var wave = Waves[~~((x/rangeX) * Waves.length)] * ratio;
                    displayObj.graphics.lineTo(startX + x, startY + y + (wave) - (250/2));
                }
            }

            function addBullet(x, y) {
                if (Math.abs(lastAddBullet - new Date() * 1) > 60000 / bpm) {
                    lastAddBullet = new Date() * 1;
                    bullets.push({'x':x, 'y':y, 'time':new Date() * 1});
                }
            }

            function hideWarning() {
                warningAccepted = true;
                acceptBtn.visible = false;
                t1.visible = false;
                t2.visible = false;
                warningbg.visible = false;

                weapon.visible = true;
                sideWalls.visible = true;
                graph.visible = true;
                player.visible = true;
            }

            window.requestAnimFrame = (function(){
              return  window.requestAnimationFrame       ||
                      window.webkitRequestAnimationFrame ||
                      window.mozRequestAnimationFrame    ||
                      function( callback ){
                        window.setTimeout(callback, 1000 / 60);
                      };
            })();

        </script>
    </head>
    <body onload="Init()">
        <canvas id="canvas"></canvas><br><br>
        <input type="file" name="file" id="fileUploadForm"><br>
    </body>
</html>
